{% extends "base.html" %}

{% block title %}My Inventory - The Lotus TCG{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>My Inventory</h2>
                    <p class="text-muted mb-0">Manage your card collection</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-info fs-6">{{ total_items }} total items</span>
                    <a href="{{ url_for('inventory_consigned') }}" class="btn btn-outline-secondary btn-sm ms-2">
                        <i class="fas fa-warehouse me-1"></i>Sent to Shop
                    </a>
                    <a href="{{ url_for('my_transfer_history') }}" class="btn btn-outline-primary btn-sm ms-2">
                        <i class="fas fa-history me-1"></i>Transfer History
                    </a>
                </div>
            </div>


            <!-- Inventory Visibility Toggle -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i>Inventory Visibility
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">Make Inventory Public</h6>
                            <p class="text-muted mb-0">
                                {% if user_inventory.is_public %}
                                    Your inventory is <strong>public</strong> - other users can see your collection
                                {% else %}
                                    Your inventory is <strong>private</strong> - only you can see your collection
                                {% endif %}
                            </p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="publicToggle"
                                   {% if user_inventory.is_public %}checked{% endif %}
                                   onchange="toggleInventoryVisibility()">
                            <label class="form-check-label" for="publicToggle">
                                {% if user_inventory.is_public %}Public{% else %}Private{% endif %}
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Statistics -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <div class="display-4 text-primary mb-2">
                                <i class="fas fa-cubes"></i>
                            </div>
                            <h5 class="card-title">{{ total_items }}</h5>
                            <p class="card-text text-muted">Total Items</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <div class="display-4 text-success mb-2">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h5 class="card-title">{{ verified_items }}</h5>
                            <p class="card-text text-muted">Verified Items</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <div class="display-4 text-info mb-2">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <h5 class="card-title">{{ "{:,.0f}".format(total_value) }}</h5>
                            <p class="card-text text-muted">Est. Value (VND)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <div class="display-4 text-warning mb-2">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <h5 class="card-title">{{ inventory_items|length if inventory_items else 0 }}</h5>
                            <p class="card-text text-muted">Unique Cards</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- CSV Import/Export Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-file-csv me-2"></i>CSV Import/Export
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Import from CSV</h6>
                            <p class="text-muted small mb-3">Upload a CSV file to bulk import items to your inventory</p>
                            <form action="{{ url_for('upload_user_inventory_csv') }}" method="post" enctype="multipart/form-data">
                                <div class="input-group mb-3">
                                    <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                                    <button class="btn btn-outline-primary" type="submit">
                                        <i class="fas fa-upload me-1"></i>Import
                                    </button>
                                </div>
                            </form>
                            <a href="{{ url_for('download_user_inventory_template_csv') }}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-download me-1"></i>Download Template
                            </a>
                        </div>
                        <div class="col-md-6">
                            <h6>Export to CSV</h6>
                            <p class="text-muted small mb-3">Download your current inventory as a CSV file</p>
                            <a href="{{ url_for('download_user_inventory_csv') }}" class="btn btn-outline-success">
                                <i class="fas fa-download me-1"></i>Export Inventory
                            </a>
                        </div>
                    </div>
                    <hr>
                    <h6><i class="fas fa-info-circle me-2"></i>CSV Format Guidelines</h6>
                    <ul class="mb-0 small">
                        <li><strong>Required columns:</strong> name, quantity</li>
                        <li><strong>Optional columns:</strong> set_name, rarity, condition, sale_price, market_price, is_for_sale, language, notes, grade, foil_type, description, image_url</li>
                        <li><strong>Data types:</strong> quantity (integer), sale_price/market_price (decimal), is_for_sale (true/false)</li>
                        <li><strong>Encoding:</strong> UTF-8 recommended</li>
                        <li><strong>Max file size:</strong> 10MB</li>
                    </ul>
                </div>
            </div>

            <!-- Add Item Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Add Item to Inventory
                    </h6>
                </div>
                <div class="card-body">
                    <form id="addItemForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cardName" class="form-label">Card Name *</label>
                                <input type="text" class="form-control" id="cardName" name="card_name" required
                                       placeholder="Enter card name">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="cardSet" class="form-label">Set</label>
                                <input type="text" class="form-control" id="cardSet" name="card_set"
                                       placeholder="Card set">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="cardRarity" class="form-label">Rarity</label>
                                <select class="form-select" id="cardRarity" name="card_rarity">
                                    <option value="Common">Common</option>
                                    <option value="Rare">Rare</option>
                                    <option value="Super Rare">Super Rare</option>
                                    <option value="Majestic">Majestic</option>
                                    <option value="Legendary">Legendary</option>
                                    <option value="Promo">Promo</option>
                                    <option value="Treasure">Treasure</option>
                                    <option value="Marvel">Marvel</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="quantity" class="form-label">Quantity *</label>
                                <input type="number" class="form-control" id="quantity" name="quantity"
                                       min="1" value="1" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="condition" class="form-label">Condition</label>
                                <select class="form-select" id="condition" name="condition">
                                    <option value="Near Mint">Near Mint</option>
                                    <option value="Light Play">Light Play</option>
                                    <option value="Moderate Play">Moderate Play</option>
                                    <option value="Heavy Play">Heavy Play</option>
                                    <option value="Damaged">Damaged</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="foiling" class="form-label">Foiling</label>
                                <select class="form-select" id="foiling" name="foiling">
                                    <option value="NF">Non Foil (NF)</option>
                                    <option value="RF">Rainbow Foil (RF)</option>
                                    <option value="CF">Cold Foil (CF)</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="art_style" class="form-label">Art Style</label>
                                <select class="form-select" id="art_style" name="art_style">
                                    <option value="Normal">Normal</option>
                                    <option value="EA">Extended Art (EA)</option>
                                    <option value="WB">White Border (WB)</option>
                                    <option value="ALT">Alternate Art (ALT)</option>
                                    <option value="GF">Golden (GF)</option>
                                    <option value="Marvel">Marvel</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cardImage" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="cardImage" name="card_image"
                                       placeholder="https://example.com/card-image.jpg">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="description" class="form-label">Description</label>
                                <textarea class="form-control" id="description" name="description"
                                          rows="2" placeholder="Optional description"></textarea>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add to Inventory
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearAddForm()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Bulk Actions -->
            <div class="card mb-4" id="bulkActions" style="display: none;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span id="selectedCount">0</span> items selected
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-danger btn-sm" onclick="bulkDelete()">
                                <i class="fas fa-trash me-1"></i>Bulk Delete
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                                <i class="fas fa-times me-1"></i>Clear Selection
                            </button>
                        </div>
                    </div>

                    <!-- Withdraw Controls -->
                    <div class="border rounded p-3">
                        <div class="mb-2"><strong><i class="fas fa-dolly me-2"></i>Withdraw Selected Items</strong></div>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-12">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="withdrawMethod" id="withdrawPickup" value="pickup" checked onchange="toggleWithdrawMethod()">
                                    <label class="form-check-label" for="withdrawPickup">Pickup</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="withdrawMethod" id="withdrawShipping" value="shipping" onchange="toggleWithdrawMethod()">
                                    <label class="form-check-label" for="withdrawShipping">Shipping</label>
                                </div>
                            </div>

                            <div class="col-md-6" id="pickupFields">
                                <label for="pickupLocation" class="form-label">Pickup Location</label>
                                <select class="form-select" id="pickupLocation">
                                    <option value="Iron Hammer">Iron Hammer</option>
                                    <option value="Floating Dojo">Floating Dojo</option>
                                </select>
                            </div>

                            <div class="col-md-6 d-none" id="shippingFields">
                                <div class="row g-2">
                                    <div class="col-12">
                                        <label class="form-label" for="shipAddress">Address</label>
                                        <input type="text" class="form-control" id="shipAddress" placeholder="Leave blank to use your profile address">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="shipCity">City</label>
                                        <input type="text" class="form-control" id="shipCity" placeholder="Use profile if blank">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="shipProvince">Province</label>
                                        <input type="text" class="form-control" id="shipProvince" placeholder="Use profile if blank">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="shipPostal">Postal Code</label>
                                        <input type="text" class="form-control" id="shipPostal" placeholder="Use profile if blank">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" for="shipCountry">Country</label>
                                        <input type="text" class="form-control" id="shipCountry" value="Vietnam">
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-12 mt-2">
                                <button class="btn btn-primary" onclick="withdrawSelected()"><i class="fas fa-truck-loading me-1"></i>Withdraw Selected</button>
                            </div>
                        </div>
                        <div class="form-text mt-2">Set per-item withdrawal quantities in each card below.</div>
                    </div>
                </div>
            </div>

            <!-- Inventory Items -->
            {% if inventory_items %}
                <div class="row">
                    {% for item in inventory_items %}
                    <div class="col-xl-4 col-lg-6 col-md-6 mb-4">
                        <div class="card h-100">
                           <div class="card-header">
                               <div class="d-flex align-items-center">
                                   <input type="checkbox" class="form-check-input me-2 item-checkbox flex-shrink-0"
                                          value="{{ item.id }}"
                                          data-verified="{{ 'true' if (item.is_verified or item.verification_status == 'verified') else 'false' }}"
                                          onchange="updateBulkActions()">
                                   <strong class="text-truncate flex-grow-1">{{ item.card_name }}</strong>
                               </div>
                           </div>
                            <div class="card-body">
                                <!-- Status badges -->
                                <div class="d-flex gap-2 mb-3">
                                    {% if item.verification_status == 'verified' %}
                                        <span class="badge bg-success" title="Verified by admin">
                                            <i class="fas fa-check me-1"></i>Verified
                                        </span>
                                    {% elif item.verification_status == 'pending' %}
                                        <span class="badge bg-warning text-dark" title="Pending verification">
                                            <i class="fas fa-clock me-1"></i>Pending
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary" title="Unverified">
                                            <i class="fas fa-question me-1"></i>Unverified
                                        </span>
                                    {% endif %}
                                    {% if item.is_public %}
                                        <span class="badge bg-info" title="Public - visible in catalog">
                                            <i class="fas fa-globe me-1"></i>Public
                                        </span>
                                    {% endif %}
                                </div>
                                <div class="text-center mb-3">
                                    {% if item.card_image %}
                                        <img src="{{ item.card_image }}" alt="{{ item.card_name }}"
                                             class="img-fluid rounded" style="height: 150px; width: auto; max-width: 100%; object-fit: contain;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display: none;">
                                            <i class="fas fa-image fa-3x text-muted"></i>
                                            <p class="text-muted small mt-1">No Image</p>
                                        </div>
                                    {% else %}
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                        <p class="text-muted small mt-1">No Image</p>
                                    {% endif %}
                                </div>

                                <div class="small">
                                    <p class="mb-1"><strong>Set:</strong> {{ item.card_set }}</p>
                                    <p class="mb-1"><strong>Condition:</strong>
                                        <span class="badge bg-secondary">{{ item.condition }}</span>
                                    </p>
                                    <p class="mb-1"><strong>Rarity:</strong>
                                        <span class="badge bg-light text-dark">{{ item.card_rarity }}</span>
                                    </p>
                                    <p class="mb-1 d-flex align-items-center justify-content-between">
                                        <span><strong>Quantity:</strong> <span id="qtyVal{{ item.id }}">{{ item.quantity }}</span></span>
                                        <span class="ms-2">
                                            <label for="withdrawQty{{ item.id }}" class="form-label me-1 mb-0 small">Withdraw</label>
                                            <input type="number" class="form-control d-inline-block" style="width: 90px;" id="withdrawQty{{ item.id }}" min="1" max="{{ item.quantity }}" value="1">
                                        </span>
                                    </p>
                                    <p class="mb-1"><strong>Market Price:</strong>
                                        <span class="text-muted">{{ "{:,.0f}".format(item.card_price) }} VND</span>
                                    </p>
                                    <p class="mb-1"><strong>Added:</strong>
                                        <span class="text-muted">{{ item.added_at.strftime('%Y-%m-%d') }}</span>
                                    </p>
                                    <p class="mb-1"><strong>Visibility:</strong>
                                        {% if item.is_public %}
                                            <span class="badge bg-info">Public</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Private</span>
                                        {% endif %}
                                    </p>
                                    {% if item.card_set != 'CREDIT' %}
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="listToggle{{ item.id }}" {% if item.listed_for_sale %}checked{% endif %}
                                               onchange="onListToggleChange({{ item.id }}, this.checked)">
                                        <label class="form-check-label" for="listToggle{{ item.id }}">List for sale in shop</label>
                                    </div>
                                    <div class="input-group input-group-sm mb-2" id="listQtyWrap{{ item.id }}" style="display: none; max-width: 260px;">
                                        <span class="input-group-text">Qty</span>
                                        <input type="number" class="form-control" id="listQty{{ item.id }}" min="1" max="{{ item.quantity }}" value="{{ item.quantity }}">
                                        <button class="btn btn-outline-primary" type="button" onclick="listSendToShop({{ item.id }})">Send</button>
                                    </div>
                                    {% else %}
                                    <div class="text-muted small">Listing disabled for credit tokens.</div>
                                    {% endif %}
                                </div>
                            </div>
                           <div class="card-footer">
                               <div class="row g-2">
                                   <div class="col-4">
                                       <a href="{{ url_for('view_inventory_item', item_id=item.id) }}"
                                          class="btn btn-outline-primary btn-sm w-100">
                                           <i class="fas fa-eye me-1"></i>Details
                                       </a>
                                   </div>
                                   <div class="col-4">
                                       <a href="{{ url_for('edit_inventory_item', item_id=item.id) }}"
                                          class="btn btn-outline-secondary btn-sm w-100">
                                           <i class="fas fa-edit me-1"></i>Edit
                                       </a>
                                   </div>
                                   <div class="col-4">
                                       <button class="btn btn-outline-success btn-sm w-100" type="button"
                                               onclick="openTransferModal({{ item.id }}, '{{ item.card_name|replace("'","\'") }}', {{ item.quantity }})">
                                           <i class="fas fa-exchange-alt me-1"></i>Transfer
                                       </button>
                                   </div>
                               </div>
                           </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Empty Inventory -->
                <div class="text-center py-5">
                    <i class="fas fa-box-open display-1 text-muted mb-4"></i>
                    <h4>Your inventory is empty</h4>
                    <p class="text-muted mb-4">Start building your collection by adding cards from the catalog.</p>
                    <a href="{{ url_for('catalog') }}" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Browse Catalog
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Transfer Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="transferItemId" />
        <div class="mb-3">
          <label class="form-label">Item</label>
          <div class="form-control" id="transferItemName" readonly></div>
        </div>
        <div class="mb-3">
          <label for="transferToUsername" class="form-label">Recipient Username</label>
          <input type="text" class="form-control" id="transferToUsername" list="userSuggestionList" placeholder="e.g., john_doe">
          <datalist id="userSuggestionList"></datalist>
        </div>
        <div class="mb-1">
          <label for="transferQty" class="form-label">Quantity</label>
          <input type="number" class="form-control" id="transferQty" min="1" value="1">
          <div class="form-text">Available: <span id="transferAvail">0</span></div>
        </div>
        <div class="small text-muted mt-2">
          Note: Verified status is preserved on transfer.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="submitTransfer()">Confirm Transfer</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<style>
/* Ensure consistent button sizing in inventory cards */
.card-footer .btn {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.75rem;
}

/* Card layout improvements */
.card {
    max-width: 100%;
}

.card-header {
    padding: 0.75rem;
    overflow: hidden;
}

.card-header strong {
    font-size: 1rem;
    line-height: 1.2;
}

/* Status badges in card body */
.card-body .badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.5rem;
    margin-bottom: 0.5rem;
}

/* Ensure card content fits properly */
.card-body {
    padding: 1rem 0.75rem;
}

/* Responsive card sizing */
@media (max-width: 768px) {
    .col-xl-4, .col-lg-6, .col-md-6 {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
}
</style>
<script>
// Global variables
let selectedItems = new Set();


// Bulk operations
function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.item-checkbox:checked');
    selectedItems.clear();

    checkboxes.forEach(checkbox => {
        selectedItems.add(parseInt(checkbox.value));
    });

    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');

    if (selectedItems.size > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = selectedItems.size;
    } else {
        bulkActions.style.display = 'none';
    }
}

function clearSelection() {
    document.querySelectorAll('.item-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBulkActions();
}

function bulkEdit() {
    if (selectedItems.size === 0) {
        showMessage('Please select items to edit.', 'warning');
        return;
    }

    // For now, show a message. In a full implementation, this would open a bulk edit modal
    showMessage(`Bulk edit functionality for ${selectedItems.size} items coming soon!`, 'info');
}

function bulkDelete() {
    if (selectedItems.size === 0) {
        showMessage('Please select items to delete.', 'warning');
        return;
    }

    if (!confirm(`Are you sure you want to delete ${selectedItems.size} items? This action cannot be undone.`)) {
        return;
    }

    // Delete items one by one
    const promises = Array.from(selectedItems).map(itemId =>
        fetch(`/api/inventory/item/${itemId}`, {
            method: 'DELETE',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.json())
    );

    Promise.all(promises).then(results => {
        const successCount = results.filter(r => r.success).length;
        const failCount = results.length - successCount;

        if (successCount > 0) {
            showMessage(`Successfully deleted ${successCount} items.`, 'success');
            setTimeout(() => location.reload(), 1000);
        }
        if (failCount > 0) {
            showMessage(`Failed to delete ${failCount} items.`, 'error');
        }
    }).catch(error => {
        console.error('Bulk delete error:', error);
        showMessage('An error occurred during bulk delete.', 'error');
    });
}


// Existing functions
function toggleWithdrawMethod() {
    const pickup = document.getElementById('withdrawPickup').checked;
    const pickupFields = document.getElementById('pickupFields');
    const shippingFields = document.getElementById('shippingFields');
    if (pickup) {
        pickupFields.classList.remove('d-none');
        shippingFields.classList.add('d-none');
    } else {
        pickupFields.classList.add('d-none');
        shippingFields.classList.remove('d-none');
    }
}

function withdrawSelected() {
    if (selectedItems.size === 0) {
        showMessage('Please select items to withdraw.', 'warning');
        return;
    }

    // Validate that all selected items are verified before submitting
    const invalid = [];
    selectedItems.forEach((id) => {
        const cb = document.querySelector('.item-checkbox[value="' + id + '"]');
        const isVerified = cb && cb.dataset && cb.dataset.verified === 'true';
        if (!isVerified) invalid.push(id);
    });
    if (invalid.length > 0) {
        // Popup notification for unverified selection
        alert('Some selected items are not verified and cannot be withdrawn. Please deselect unverified items.');
        showMessage('Withdrawal blocked: unverified items selected.', 'error');
        return;
    }

    const method = document.querySelector('input[name="withdrawMethod"]:checked')?.value || 'pickup';
    const payload = { items: [], shipment_method: method };

    if (method === 'pickup') {
        payload.pickup_location = document.getElementById('pickupLocation').value;
    } else {
        payload.shipping = {
            address: (document.getElementById('shipAddress').value || '').trim(),
            city: (document.getElementById('shipCity').value || '').trim(),
            province: (document.getElementById('shipProvince').value || '').trim(),
            postal_code: (document.getElementById('shipPostal').value || '').trim(),
            country: (document.getElementById('shipCountry').value || '').trim(),
        };
    }

    selectedItems.forEach((id) => {
        const qtyInput = document.getElementById('withdrawQty' + id);
        let qty = 1;
        if (qtyInput) {
            qty = parseInt(qtyInput.value) || 1;
            if (qty < 1) qty = 1;
        }
        payload.items.push({ inventory_item_id: id, quantity: qty });
    });

    // Submit to API
    fetch('/inventory/withdraw', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(payload),
    })
        .then((r) => r.json())
        .then((data) => {
            if (data.success) {
                showMessage('Withdrawal successful.', 'success');
                setTimeout(() => window.location.reload(), 800);
            } else {
                showMessage(data.error || 'Failed to withdraw items.', 'error');
            }
        })
        .catch((err) => {
            console.error('Withdraw error', err);
            showMessage('An error occurred during withdrawal.', 'error');
        });
}
function toggleInventoryVisibility() {
    const toggle = document.getElementById('publicToggle');
    const label = document.querySelector('label[for="publicToggle"]');
    const description = document.querySelector('.card-body p');
    const isPublic = toggle.checked;

    // Update label text immediately
    label.textContent = isPublic ? 'Public' : 'Private';

    fetch('/api/inventory/toggle-visibility', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ is_public: isPublic })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the description text
            if (isPublic) {
                description.innerHTML = 'Your inventory is <strong>public</strong> - other users can see your collection';
            } else {
                description.innerHTML = 'Your inventory is <strong>private</strong> - only you can see your collection';
            }

            // Show success message
            showMessage('Inventory visibility updated successfully!', 'success');
        } else {
            // Revert checkbox and label on error
            toggle.checked = !isPublic;
            label.textContent = !isPublic ? 'Public' : 'Private';
            showMessage('Failed to update inventory visibility.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert checkbox and label on error
        toggle.checked = !isPublic;
        label.textContent = !isPublic ? 'Public' : 'Private';
        showMessage('An error occurred while updating visibility.', 'error');
    });
}


function showMessage(message, type) {
    const flashContainer = document.querySelector('.flash-messages');
    if (flashContainer) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        flashContainer.appendChild(alertDiv);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 3000);
    }
}

function clearAddForm() {
    // Reset the form
    document.getElementById('addItemForm').reset();
}

// Handle add item form submission
document.getElementById('addItemForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());

    // No sale-related fields to convert

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
    submitBtn.disabled = true;

    fetch('/api/inventory/add-item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Item added to inventory successfully!', 'success');
            clearAddForm();

            // Update statistics counts instantly
            const totalItemsElement = document.querySelector('.badge.bg-info.fs-6');
            if (totalItemsElement) {
                const currentTotalText = totalItemsElement.textContent;
                const currentTotal = parseInt(currentTotalText) || 0;
                totalItemsElement.textContent = (currentTotal + 1) + ' total items';
            }

            // Reload the page to show the new item
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage(data.error || 'Failed to add item to inventory.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while adding the item.', 'error');
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Toggle listed for sale status
function toggleListedForSale(itemId, currentStatus) {
    const button = document.getElementById(`toggleBtn${itemId}`);
    const shopButton = document.getElementById(`shopBtn${itemId}`);
    const originalText = button.innerHTML;

    // Find the card container and status badges
    const card = button.closest('.card');
    const statusBadges = card.querySelectorAll('.card-body .badge');
    let listedBadge = null;

    // Find the listing status badge (more robust selector)
    statusBadges.forEach(badge => {
        if (badge.innerHTML.includes('fa-store') || badge.innerHTML.includes('fa-store-slash')) {
            listedBadge = badge;
        }
    });

    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
    button.disabled = true;

    fetch(`/api/inventory/toggle-listed-for-sale/${itemId}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newStatus = data.listed_for_sale;
            const icon = newStatus ? 'check' : 'times';
            const text = newStatus ? 'Listed' : 'Not Listed';
            const btnClass = newStatus ? 'btn-outline-success' : 'btn-outline-secondary';

            button.innerHTML = `<i class="fas fa-${icon} me-1"></i>${text}`;
            button.className = `btn ${btnClass} btn-sm w-100`;

            // Update the status badge in the card body
            if (listedBadge) {
                const badgeIcon = newStatus ? 'store' : 'store-slash';
                const badgeText = newStatus ? 'Listed' : 'Not Listed';
                const badgeClass = newStatus ? 'badge bg-success' : 'badge bg-secondary';

                listedBadge.innerHTML = `<i class="fas fa-${badgeIcon} me-1"></i>${badgeText}`;
                listedBadge.className = badgeClass;
                listedBadge.title = newStatus ? 'Actively listed for sale' : 'Not listed for sale';
            }

            // Update the "For Sale" count in statistics
            const forSaleStatsCard = Array.from(document.querySelectorAll('.card')).find(card =>
                card.querySelector('.fas.fa-tags') && card.querySelector('h5.card-title')
            );
            if (forSaleStatsCard) {
                const forSaleCountElement = forSaleStatsCard.querySelector('h5.card-title');
                const currentCount = parseInt(forSaleCountElement.textContent) || 0;
                const newCount = newStatus ? currentCount + 1 : Math.max(0, currentCount - 1);
                forSaleCountElement.textContent = newCount;
            }

            // Update the total items count in header
            const totalItemsBadge = document.querySelector('.badge.bg-info.fs-6');
            if (totalItemsBadge) {
                const currentTotalText = totalItemsBadge.textContent;
                const currentTotal = parseInt(currentTotalText) || 0;
                // Total items count doesn't change when toggling sale status, so keep it the same
                // This is just to ensure consistency
            }

            // Update shop button state
            if (!newStatus) {
                shopButton.disabled = true;
                shopButton.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Hidden';
                shopButton.className = 'btn btn-outline-secondary btn-sm w-100';

                // Also hide the "Visible in Shop" badge when unlisting
                const shopBadgeContainer = card.querySelector('.small p.mb-0');
                if (shopBadgeContainer) {
                    shopBadgeContainer.style.display = 'none';
                }
            } else {
                shopButton.disabled = false;
                const shopIcon = data.show_in_shop ? 'eye' : 'eye-slash';
                const shopText = data.show_in_shop ? 'Shop' : 'Hidden';
                shopButton.innerHTML = `<i class="fas fa-${shopIcon} me-1"></i>${shopText}`;
            }

            showMessage(data.message, 'success');
        } else {
            showMessage(data.error || 'Failed to update item status.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while updating the item status.', 'error');
    })
    .finally(() => {
        // Restore button state
        button.disabled = false;
    });
}

// Toggle show in shop status
function toggleShowInShop(itemId, currentStatus) {
    const button = document.getElementById(`shopBtn${itemId}`);
    const originalText = button.innerHTML;

    // Find the card container to locate the "Visible in Shop" badge
    const card = button.closest('.card');
    const shopBadgeContainer = card.querySelector('.small p.mb-0');

    // Show loading state
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Loading...';
    button.disabled = true;

    fetch(`/api/inventory/item/${itemId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            show_in_shop: !currentStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const newStatus = !currentStatus;
            const icon = newStatus ? 'eye' : 'eye-slash';
            const text = newStatus ? 'Shop' : 'Hidden';
            const btnClass = newStatus ? 'btn-outline-info' : 'btn-outline-secondary';

            button.innerHTML = `<i class="fas fa-${icon} me-1"></i>${text}`;
            button.className = `btn ${btnClass} btn-sm w-100`;

            console.log(`Button updated: currentStatus=${currentStatus}, newStatus=${newStatus}, text=${text}`);

            // Update the "Visible in Shop" badge instantly
            if (newStatus) {
                // Show the badge
                if (!shopBadgeContainer) {
                    // Create the badge container if it doesn't exist
                    const smallDiv = card.querySelector('.small');
                    if (smallDiv) {
                        const newBadgeP = document.createElement('p');
                        newBadgeP.className = 'mb-0';
                        newBadgeP.innerHTML = '<span class="badge bg-success">Visible in Shop</span>';
                        smallDiv.appendChild(newBadgeP);
                        console.log('Created new "Visible in Shop" badge');
                    }
                } else {
                    // Update existing badge
                    shopBadgeContainer.innerHTML = '<span class="badge bg-success">Visible in Shop</span>';
                    shopBadgeContainer.style.display = 'block';
                    console.log('Updated existing "Visible in Shop" badge');
                }
            } else {
                // Hide the badge
                if (shopBadgeContainer) {
                    shopBadgeContainer.style.display = 'none';
                    console.log('Hid "Visible in Shop" badge');
                }
            }

            showMessage(`Item ${newStatus ? 'now visible' : 'hidden'} in shop`, 'success');
        } else {
            showMessage(data.error || 'Failed to update shop visibility.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while updating shop visibility.', 'error');
    })
    .finally(() => {
        // Restore button state
        button.disabled = false;
    });
}

// Add loading state to toggle
document.getElementById('publicToggle').addEventListener('change', function() {
    this.disabled = true;
    // Re-enable after request completes (handled in toggleInventoryVisibility)
    setTimeout(() => {
        this.disabled = false;
    }, 1000);
});

// Simple listing toggle for marketplace
function setListForSale(itemId, listed, qty) {
    const payload = { listed: !!listed };
    if (listed && qty && Number(qty) > 0) {
        payload.quantity = Number(qty);
    }
    fetch(`/api/inventory/item/${itemId}/list`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        const cb = document.getElementById(`listToggle${itemId}`);
        const wrap = document.getElementById(`listQtyWrap${itemId}`);
        if (!data || !data.success) {
            if (cb) cb.checked = !listed;
            showMessage && showMessage(data?.error || 'Failed to update listing status.', 'error');
            return;
        }
        // Success paths: if we moved qty, auto uncheck and hide controls
        if (typeof data.moved !== 'undefined' && data.moved > 0) {
            if (cb) cb.checked = false;
            if (wrap) wrap.style.display = 'none';
            showMessage && showMessage(`Sent ${data.moved} to shop`, 'success');
            // Update on-card quantity and related inputs
            try {
                const qtyEl = document.getElementById(`qtyVal${itemId}`);
                if (qtyEl) {
                    const currentQty = parseInt(qtyEl.textContent || '0') || 0;
                    const newQty = Math.max(0, currentQty - Number(data.moved));
                    qtyEl.textContent = newQty;
                }
                const wInp = document.getElementById(`withdrawQty${itemId}`);
                if (wInp) {
                    const newMax = Math.max(0, parseInt(wInp.max || '0') - Number(data.moved));
                    wInp.max = String(newMax);
                    if (parseInt(wInp.value || '1') > newMax) {
                        wInp.value = newMax > 0 ? String(newMax) : '1';
                    }
                }
                const lInp = document.getElementById(`listQty${itemId}`);
                if (lInp) {
                    const currentMax = parseInt(lInp.max || '0') || 0;
                    const newMax2 = Math.max(0, currentMax - Number(data.moved));
                    lInp.max = String(newMax2);
                    lInp.value = String(newMax2 > 0 ? newMax2 : 0);
                }
                // Update header total items badge if present
                const totalBadge = document.querySelector('.badge.bg-info.fs-6');
                if (totalBadge) {
                    const m = totalBadge.textContent.match(/(\d+)/);
                    if (m) {
                        const totalNow = Math.max(0, parseInt(m[1]) - Number(data.moved));
                        totalBadge.textContent = `${totalNow} total items`;
                    }
                }
            } catch (e) { /* no-op */ }
            // Broadcast to other tabs (e.g., admin) to update admin stock display
            try {
                if (data.card_id) {
                    const payload = { ts: Date.now(), card_id: data.card_id, admin_delta: Number(data.moved) };
                    localStorage.setItem('qty_update', JSON.stringify(payload));
                }
            } catch (e) { /* ignore */ }
            return;
        }
        // Unlist success
        if (cb) cb.checked = false;
        if (wrap) wrap.style.display = 'none';
        showMessage && showMessage('Unlisted successfully', 'success');
    })
    .catch(err => {
        const cb = document.getElementById(`listToggle${itemId}`);
        if (cb) cb.checked = !listed;
        console.error('Error updating listing:', err);
        showMessage && showMessage('An error occurred while updating listing status.', 'error');
    });
}

function onListToggleChange(itemId, checked) {
    const wrap = document.getElementById(`listQtyWrap${itemId}`);
    if (checked) {
        if (wrap) {
            wrap.style.display = 'flex';
            const inp = document.getElementById(`listQty${itemId}`);
            if (inp) inp.focus();
        }
    } else {
        if (wrap) wrap.style.display = 'none';
        setListForSale(itemId, false);
    }
}

function listSendToShop(itemId) {
    const inp = document.getElementById(`listQty${itemId}`);
    const qty = inp ? Number(inp.value) : undefined;
    setListForSale(itemId, true, qty);
}

// ---------------------------
// Transfer UI Logic
// ---------------------------
let transferModalInstance = null;
let transferMaxQty = 0;

function openTransferModal(itemId, itemName, maxQty) {
    transferMaxQty = parseInt(maxQty) || 0;
    document.getElementById('transferItemId').value = itemId;
    document.getElementById('transferItemName').textContent = itemName;
    const qtyInput = document.getElementById('transferQty');
    qtyInput.value = (transferMaxQty > 0 ? 1 : 0);
    qtyInput.max = transferMaxQty;
    document.getElementById('transferAvail').textContent = transferMaxQty;

    const modalEl = document.getElementById('transferModal');
    transferModalInstance = transferModalInstance || new bootstrap.Modal(modalEl);
    transferModalInstance.show();
}

function submitTransfer() {
    const itemId = parseInt(document.getElementById('transferItemId').value);
    const toUsername = document.getElementById('transferToUsername').value.trim();
    const qty = parseInt(document.getElementById('transferQty').value);

    if (!toUsername) {
        showMessage('Please enter recipient username', 'warning');
        return;
    }
    if (!qty || qty <= 0) {
        showMessage('Please enter a valid quantity', 'warning');
        return;
    }
    if (qty > transferMaxQty) {
        showMessage('Quantity exceeds available amount', 'warning');
        return;
    }

    const idem = 'tx-' + Date.now() + '-' + Math.random().toString(36).slice(2);
    const payload = {
        from_user_id: {{ current_user.id if current_user.is_authenticated else 'null' }},
        inventory_item_id: itemId,
        to_username: toUsername,
        quantity: qty
    };

    fetch('/inventory/transfer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Idempotency-Key': idem
        },
        body: JSON.stringify(payload)
    })
    .then(r => r.json().then(j => ({ ok: r.ok, status: r.status, body: j })))
    .then(({ ok, status, body }) => {
        if (ok && body && body.success) {
            // Update UI quantity
            const qtyEl = document.getElementById('qtyVal' + itemId);
            if (qtyEl) {
                const current = parseInt(qtyEl.textContent) || transferMaxQty;
                const next = Math.max(0, current - qty);
                qtyEl.textContent = next;
            }
            showMessage('Transfer successful', 'success');
            if (transferModalInstance) transferModalInstance.hide();
            // Refresh if zero left
            if (qtyEl && parseInt(qtyEl.textContent) === 0) {
                setTimeout(() => window.location.reload(), 500);
            }
        } else {
            const msg = (body && (body.message || body.error)) ? (body.message || body.error) : 'Transfer failed';
            showMessage(msg, 'danger');
        }
    })
    .catch(err => {
        console.error(err);
        showMessage('Unexpected error during transfer', 'danger');
    });
}

// ---------------------------
// Username autocomplete (datalist)
// ---------------------------
let _userSearchTimer = null;
const _userCache = new Map();

function _debounceUserSearch(fn, delay=200) {
    return (...args) => {
        if (_userSearchTimer) clearTimeout(_userSearchTimer);
        _userSearchTimer = setTimeout(() => fn(...args), delay);
    };
}

function _renderUserSuggestions(users) {
    const list = document.getElementById('userSuggestionList');
    if (!list) return;
    list.innerHTML = '';
    users.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.username;
        opt.label = u.full_name ? `${u.username}  ${u.full_name}` : u.username;
        list.appendChild(opt);
    });
}

const _doUserSearch = _debounceUserSearch((q) => {
    const key = q.toLowerCase();
    if (_userCache.has(key)) {
        _renderUserSuggestions(_userCache.get(key));
        return;
    }
    fetch(`/api/users/search?q=${encodeURIComponent(q)}&limit=10`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        const results = Array.isArray(data?.results) ? data.results : [];
        _userCache.set(key, results);
        _renderUserSuggestions(results);
    })
    .catch(() => {/* ignore */});
}, 250);

function _bindUserAutocomplete() {
    const inp = document.getElementById('transferToUsername');
    if (!inp) return;
    inp.addEventListener('input', (e) => {
        const q = e.target.value.trim();
        if (q.length < 2) {
            _renderUserSuggestions([]);
            return;
        }
        _doUserSearch(q);
    });
}

document.addEventListener('DOMContentLoaded', _bindUserAutocomplete);

</script>
{% endblock %}
