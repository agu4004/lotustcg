{% extends "base.html" %}

{% block title %}My Consigned Cards - The Lotus TCG{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="fas fa-warehouse me-2"></i>Cards Sent to Shop</h2>
    <a href="{{ url_for('user_inventory') }}" class="btn btn-outline-secondary">
      <i class="fas fa-arrow-left me-1"></i>Back to Inventory
    </a>
  </div>

  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Current Consignments</h5>
    </div>
    <div class="card-body">
      {% if items %}
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle" id="consignedTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Set</th>
              <th>Foiling</th>
              <th>Art Style</th>
              <th class="text-end">Quantity</th>
              <th style="width:240px;">Withdraw</th>
            </tr>
          </thead>
          <tbody>
            {% for row in items %}
            <tr>
              <td>{{ row.card_name }}</td>
              <td>{{ row.set_name }}</td>
              <td>{{ row.foiling }}</td>
              <td>{{ row.art_style }}</td>
              <td class="text-end"><span id="qty{{ row.id }}">{{ row.quantity }}</span></td>
              <td>
                <div class="input-group input-group-sm">
                  <input type="number" class="form-control" id="wdQty{{ row.id }}" min="1" max="{{ row.quantity }}" value="1">
                  <button class="btn btn-outline-primary" onclick="withdrawConsignment({{ row.id }})">Withdraw</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center text-muted py-4">You have no cards consigned to the shop.</div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function withdrawConsignment(shopId) {
  const qtyEl = document.getElementById('wdQty' + shopId);
  const reqQty = parseInt(qtyEl && qtyEl.value ? qtyEl.value : '0');
  if (!reqQty || reqQty <= 0) return;

  fetch(`/api/inventory/consignment/${shopId}/withdraw`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ quantity: reqQty })
  })
  .then(r => r.json())
  .then(data => {
    if (!data || !data.success) {
      alert(data?.error || 'Failed to withdraw');
      return;
    }
    // Update row qty
    const qtySpan = document.getElementById('qty' + shopId);
    if (qtySpan) qtySpan.textContent = data.remaining;
    if (qtyEl) {
      qtyEl.max = String(data.remaining);
      if (parseInt(qtyEl.value || '1') > data.remaining) {
        qtyEl.value = data.remaining > 0 ? String(data.remaining) : '1';
      }
    }
    // Broadcast admin stock decrease to other tabs
    try {
      if (data.card_id && data.withdrawn) {
        const payload = { ts: Date.now(), card_id: data.card_id, admin_delta: -Number(data.withdrawn) };
        localStorage.setItem('qty_update', JSON.stringify(payload));
      }
    } catch (e) {}
    // If zero remaining, disable controls
    if (data.remaining <= 0) {
      if (qtyEl) qtyEl.disabled = true;
      const btn = qtyEl?.nextElementSibling;
      if (btn) btn.disabled = true;
    }
  })
  .catch(() => alert('Error withdrawing consignment'));
}
</script>
{% endblock %}
